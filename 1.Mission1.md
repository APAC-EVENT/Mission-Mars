# 미션 1

## 미션 목표

로그를 사용하여 시스템을 학습시키기 전에, 데이터를 정제하는 과정인 전처리 작업을 해주어야 합니다. R 언어 및 모듈을 이용하여 주어진 포맷에 따라 입력 값을 사전처리 하도록 하겠습니다.
텍스트 편집기를 사용해 파일을 열어보면, logMessage 열에 || 구분자로 분리된 불필요한 추가 정보가 포함된 것을 확인하실 수 있습니다. logMessage 열을 정제한 후 logMessage 데이터를 학습시키는 것이 이번 미션의 핵심입니다.

### Azure Machine Learning Studio 접속

1. [studio.azureml.net](http://studio.azureml.net) 접속
: Azure ML Studio에 접속하시기 바랍니다. 무료로 Azure Machine Learning을 사용해볼 수 있는 계정을 만드실 수 있습니다. 

2.	**Sign up** 클릭

![1_01](/images/1_01.PNG)

3.	두번째 **Free Workspace** 선택
: Microsoft 계정(ex. outlook.com 이나 hotmail.com 메일 계정)이 있으신 경우 "Sign In" 버튼을 눌러서 로그인 하시고, 없으신 경우 "Sign up here"을 눌러서 Microsoft 계정을 새로 생성하시기 바랍니다.

![1_02](/images/1_02.PNG)

### Dataset 추가

가장 먼저 해야 할 일은 오늘 실습에 사용할 Dataset을 업로드하는 작업입니다. 

1. Dataset 다운로드
: [https://github.com/APAC-EVENT/Mission-Mars/blob/master/dataset/ShipLog.zip](https://github.com/APAC-EVENT/Mission-Mars/blob/master/dataset/ShipLog.zip)에 접속하셔서 **Download**버튼을 눌러서 ShipLog.zip 파일을 다운받으신 후 압축을 푸시기 바랍니다. 

![1_06](/images/1_06.PNG)

2. Dataset 추가
: 화면의 하단 왼쪽에 위치한 **+ NEW -> DATASET -> FROM LOCAL FILE**을 차례대로 선택한 후, **ShipLog.csv** 파일을 업로드 하시기 바랍니다.  

![1_03](/images/1_03.PNG)
![1_04](/images/1_04.PNG)
![1_05](/images/1_05.PNG)
: 파일 업로드시, 파일의 형식이 **Generic CSV File with a header (.csv)** 인지 확인하시기 바랍니다.

이제 Mission Mars를 시작할 준비가 모두 다 되었습니다. 오늘 실습할 내용의 전체적인 Workflow는 다음과 같으니 참고해주세요!

![1_07](/images/1_07.jpg)

## 새로운 실험 추가

“New” -> “Experiment” 탭 -> “Blank Experiment”를 차례로 클릭하여 새로운 실험을 생성할 수 있습니다. 

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars04.png)

새로운 실험을 생성하면 대시보드로 리디렉션되는데, 여기에서 3개의 패널을 볼 수 있습니다. 왼쪽에 있는 패널은 실험 아이템 목록이 될 패널로, 데이터 입력 및 출력 삽입 또는 웹 서비스 모듈을 비롯해 실험 진행에 필요한 모든 모듈을 포함하고 있습니다.

대시보드 중간에 있는 패널에서는 왼쪽 패널에 있는 아이템을 드래그 앤 드롭하여 이동시키고 각각의 아이템을 서로 연결하며 추가 설정/시각화를 확인할 수 있습니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars05.png)

## 데이터 세트 삽입
왼쪽의 아이템 패널에서 Saved Dataset를 선택하여 My Datasets를 선택한 다음, 업로드된 데이터 세트를 클릭할 수 있습니다. 이 아이템을 드래그 앤 드롭하여 대시보드로 옮기거나 그냥 더블 클릭하면 됩니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars06.png)

## 데이터 준비
### R 스크립트 실행
미션 목표는 "logMessage" 열을 분할해 데이터를 클리닝하는 것입니다. 해당 열에 || 구분자가 있다는 정보가 제공될 것입니다. 왼쪽 패널에서 "Execute R Script" 아이템을 검색한 후 선택, 드래그 앤 드롭함으로써 R 스크립트를 사용하여 미션 목표를 달성할 수 있습니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars07.png)

데이터 세트의 왼쪽 출력 라인을 R 스크립트의 입력 포트로 드래그하여 데이터 세트를 R 스크립트에 연결합니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars08.png)

그 후 오른쪽 패널의 내부 스크립트를 다음과 같이 교체합니다.(기존의 스크립트 완전히 삭제)

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars09.png)

```R
# Map 1-based optional input ports to variables
df <- maml.mapInputPort(1) # class: data.frame

splitdata <- strsplit(as.character(df$logMessage),'||',fixed=TRUE) 

dfoutput <- data.frame(df$id, df$severity, do.call(rbind, splitdata))

maml.mapOutputPort("dfoutput");
```

이 스크립트가 하는 일 : df가 입력 포트 1에서 데이터 프레임을 가져올 것입니다. 이러한 입력 포트 숫자는 Dataset 아이템에서 선들을 연결할 때 볼 수 있고, 해당 코드에 알맞게 선을 연결해야 합니다. 이 경우, Port \#1에 선을 연결해주어야 합니다. 그러면 가변 splitdata를 생성할 수 있는데 여기에서 **||** 구분자를 포함하고 있는 logMessage 열을 선택하여 스트링 분할을 수행합니다. 여기서 logMessage는 **||**를 기준으로 두 String으로 쪼갤 수 있습니다. 그 다음 데이터를 ID, 심각도, splitdata 기능과 결합하여 기능을 실행합니다.

하단바에서 Save를 클릭하여 저장한 후 Run을 클릭합니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars10.png)

그러면 data.frame가 출력됩니다.

### 새로운 열 매핑
R 스크립트를 실행하고 나면 X1이라는 사용 불가능한 열을 제외해야 합니다. "Select Column In Dataset" 모듈을 드래그 앤 드롭하고 R 출력을 이 모듈의 입력에 연결합니다. 참고로, 여기서 생성된 X1과 X2는 아까 전 **||**으로 split한 두 String입니다. 실제 data를 보면 첫째 String은 의미가 없고, 둘째 String만 의미가 있는 문장임을 알 수 있습니다. 하지만 방금 R 코드에서는 두 String의 각자의 이름을 붙여주지 않았기 때문에, 임의로 X1, X2라는 이름이 붙었습니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars11.png)

오른쪽 패널에서 Launch Column selector를 클릭한 뒤 "Exclude"를 클릭하고 X1 열을 선택하여 제외합니다. 그러면 X1 열을 제외한 모든 열로 구성된 새로운 출력이 생성됩니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars12.png)

하단바에서 Save를 클릭하여 저장한 후 Run을 클릭합니다.(Run selected로 해당 모듈만 실행하셔도 괜찮습니다)

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars13.png)

### 메타데이터 편집
"Edit Metadata"를 드래그하여 대시보드에 드롭한 뒤 열 이름을 변경하고 싶을 경우 오른쪽 패널에서 Launch Column selector 선택한 뒤 df.severity, df.id 및 X2를 포함하도록 선택하십시오.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars14.png)

이제 New column names 필드에 ID, category 및text를 입력합니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars15.png)

### Clean Stop Words
그 다음으로 우리가 해야 할 일은 모든 Stop words 가 제거되도록 텍스트를 Clean하는 것입니다. 우리가 가지고있는 데이터를 보면 텍스트에도 숫자가 표시됩니다. 이 텍스트는  전처리를 사용하여 훈련 데이터에서 제외 해야합니다. 우리는 마이크로소프트에서 제공하는 Stop words를 텍스트 프로세싱 패키지에 연결하는 인풋으로 사용할 것입니다. 

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars16.png)

왼쪽 패널에서 Import Data를 추가한 후 Launch Import Data Wizard를 클릭한 후 Web URL via HTTP 를 선택하세요.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars17.png)

오른쪽 아래의 화살표를 눌러 2번째 페이지로 이동하여 Data Source URL에 [http://azuremlsamples.azureml.net/templatedata/Text - Sentiment Stopwords.tsv](http://azuremlsamples.azureml.net/templatedata/Text\ -\ Sentiment\ Stopwords.tsv)를 입력하고 Data format을 TSV로 변경합니다. (*다른 모듈에 연결하지 않고 다음 스텝으로 넘어가세요)

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars18.png)

### Uploading Preprocessing Text Package.

왼쪽 패널에서 text.preprocessing.zip을 검색하면 Saved Datasets의 Samples 아래에 해당 파일이 있습니다. 해당 파일을 중앙 패널로 끌어오시면 됩니다(드래그앤드롭). 이번에도 이 모듈을 연결하지 않고 다음 스텝으로 넘어갑니다.

### Execute R script
다시 한번 Excute R script 를 왼쪽 패널에서 중앙으로 끌어옵니다.

이 R Script는 input data를 결합합니다(Train data의 input data1, stop words의 input data2, preprocess text의 input data3)

이를 위해서 오른쪽 패널에서 스크립트를 아래의 스크립트로 대체합니다 :

```R
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
# Please determine the required text preprocessing steps using the following flag 
replace_special_chars <- TRUE
remove_duplicate_chars <- TRUE
replace_numbers <- TRUE
convert_to_lower_case <- TRUE
remove_default_stopWords <- FALSE
remove_given_stopWords <- TRUE
stem_words <- TRUE
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 

# Map 1-based optional input ports to variables
dataset1 <- maml.mapInputPort(1) # class: data.frame
# get the label and text columns from the input data set
text_column <- dataset1[["text"]]
label_column <- dataset1[["category"]]

stopword_list <- NULL
result <- tryCatch({
   dataset2 <- maml.mapInputPort(2) # class: data.frame
   # get the stopword list from the second input data set
   stopword_list <- dataset2[[1]]
}, warning = function(war) {
   # warning handler 
   print(paste("WARNING: ", war))
}, error = function(err) {
   # error handler
   print(paste("ERROR: ", err))
   stopword_list <- NULL
}, finally = {})
 
# Load the R script from the Zip port in ./src/
source("src/text.preprocessing.R");
                            
text_column <- preprocessText(text_column, 
                         replace_special_chars,
                         remove_duplicate_chars,
                         replace_numbers,
                         convert_to_lower_case,
                         remove_default_stopWords,
                         remove_given_stopWords,
                         stem_words, 
                         stopword_list)                   

data.set <- data.frame(
                label_column,
                text_column,
                stringsAsFactors = FALSE 
                )    

# Select data.frame to be sent to the output Dataset port
maml.mapOutputPort("data.set")

```

그 이후 Edit Metadata를 Excute R Script 모듈의 맨 왼쪽 입력에 연결합니다. 그리고 중앙 입력 모듈에는 아까 생성한 Import Data, 맨 오른쪽 입력에는 text.preprocessing.zip을 연결합니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars19.png)

### 데이터 분할
Split Data 기능을 이용하여 데이터를 2개로 분할합니다. "Rows"를 분할 모드로 사용하고 Fraction은 0.7로 선택해 분할합니다. 데이터 세트의 70%는 훈련 데이터로, 나머지 30%는 테스트 데이터로 사용할 것입니다.

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars20.png)

이 미션을 마무리하고 나면 대시보드가 이렇게 되어 있을 것입니다. 

여기서 다시한번 Save와 Run을 해주세요.

축하합니다! Mission 1을 완성하였습니다. Mission 1을 완성했다면 2, 3는 빠르게 진행됩니다. 

![](https://jyseongfileshare.blob.core.windows.net/images/MissionMars21.png)
